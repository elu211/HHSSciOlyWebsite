name: Update README

on:
  push:
    branches:
      - main

env:
  GH_TOKEN: ${{ secrets.GH_TOKEN }}

permissions:
  contents: write
  issues: write

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Clone Directory
        run: |
          git clone "https://github.com/elu211/HHSSciOlyWebsite"
          cd HHSSciOlyWebsite
          
      - name: Authenticate with GitHub
        run: |
          git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/elu211/HHSSciOlyWebsite

      - name: Run update script
        run: |
          # Fetch the latest changes
          git fetch

          # Get the commit history for the past week
          commit_info=$(git log --since="7 days ago" --pretty=format:"%an")
          
          # Read the README file and replace the placeholder section
          awk -v commit_info="$commit_info" '
          BEGIN {
              section = 0;
              split(commit_info, commits, "\n");
              for (i in commits) {
                  author = commits[i];
                  if (author != "") {
                      commit_count[author]++;
                  }
              }
          }
          /<!-- COMMIT_SECTION_START -->/ {
              print;
              section = 1;
              for (author in commit_count) {
                  print author ": " commit_count[author] " commits";
              }
              next;
          }
          /<!-- COMMIT_SECTION_END -->/ {
              section = 0;
          }
          !section {
              print;
          }
          ' README.md > README.tmp && mv README.tmp README.md

          # # Get the list of contributors and their commit counts for the past week
          # commit_info=$(git log --since="7 days ago" --pretty=format:"%h - %an: %s (%ci)")

          # awk -v commit_info="$commit_info" '
          # int; section = 1; print commit_info; next }
          # /<!-- COMMIT_S>           BEGIN { section = 0 }
          # /<!-- COMMIT_SECTION_START -->/ { print; section = 1; print commit_info; next }
          # /<!-- COMMIT_SECTION_END -->/ { section = 0 }
          # !section { print }
          # ' README.md > README.tmp && mv README.tmp README.md

          # cat README.tmp

          # awk -v commit_info="$commit_info" '
          # BEGIN { section = 0 }
          # /<!-- COMMIT_SECTION_START -->/ { print; section = 1; print commit_info; next }
          # /<!-- COMMIT_SECTION_END -->/ { section = 0 }
          # !section { print }
          # ' README.md > README.tmp && mv README.tmp README.md

          # Commit and push changes
          git add README.md
          git commit -m "Update README with commits by contributors in the past week"
          git push
